Para o armazenamento da temperatura do sensor DS18B20 em função do tempo, assim como a geração de um gráfico com o histórico de temperaturas para o usuário do sistema, foram escritos dois \textit{scripts} em Python, sendo a saída do \textit{script} de \textit{log} a entrada do \textit{script} de geração do gráfico --- embora ambos possam ser executados independentemente, a geração do gráfico precisa de um arquivo contendo o histórico de temperaturas.

\subsection{Registro de temperatura}
\label{python_sec}
Para o arquivo do \textit{log}, foram primeiramente escritas algumas funções:

\begin{itemize}
	\item \textbf{tread()} --- lê o arquivo referente ao sensor de temperatura e retorna deste somente a temperatura formatada em graus celsius.
	\item \textbf{tprint\_all(tcelsius)} ---  recebe temperatura em \si{\degree}C e imprime com formatação HTML em \si{\degree}C, \si{\degree}F, K e \si{\degree}R; pode ser usada em conjunto com a função tread()
	\item \textbf{tprint\_all\_terminal(tcelsius)} ---  idêntica à função tprint\_all(), porém imprime com formatação
para o terminal do Linux
	\item \textbf{tlog(file = "/var/www/default.csv")} --- cria/adiciona a um arquivo de log no formato CSV a
temperatura medida e a data/hora correspondente no formato \textit{Unix epoch} --- que é definido como o número de segundos passados desde 1 de janeiro de 1970 não considerando segundos bissextos --- em intervalo de amostragem definido na função, até que o script seja interrompido de alguma maneira. Em função de erros de leitura esporádicos do sensor, se a temperatura lida for menor ou igual a zero, esta é descartada. Imprime a temperatura lida a cada amostragem. O tempo de amostragem é definido pela soma do tempo de leitura do arquivo (inerente ao sistema) com o tempo ocioso definido nesta função: para que o tempo de amostragem seja o mais próximo possível de 1s, foi realizado um estudo de caso, descrito no apêndice \ref{analise_tread_temp}, e com isso obteve-se o valor de 0,2202s ocioso definido nesta função. Além disto, nesta função é chamada \textit{tlog\_instant} que registra em um arquivo separado a última leitura válida de temperatura e tempo.
	\item \textbf{tlog\_instant(temperature, epoch, file = "/var/www/datalog/instant.csv")} --- registra a última leitura válida de temperatura e tempo em um arquivo, criando ou sobrescrevendo o mesmo.
	\item \textbf{tlog\_test(file = "/var/www/datalog/default.csv")} --- função que gera um arquivo de \textit{log} com rampas e degraus de temperatura, para uso em simulações posteriores do funcionamento do sistema, descritas na seção \ref{simulacao_controle}.
\end{itemize}

Sendo a função \textit{tlog} a mais relevante, esta pode ser obtida na caixa de código-fonte \ref{tlog_python}. O script completo está registrado no código-fonte \ref{python_log_script} do apêndice \ref{codigos_python}. Ainda assim, as funções por si só não são executadas sozinhas, portanto foi criado um script auxiliar em Python que chama a função \textit{tlog}, descrito no código-fonte \ref{tlog_log}.

\lstset{language=Python}
\begin{lstlisting}[frame=single, basicstyle=\linespread{0.85}\ttfamily, caption=Função de \textit{log} da temperatura em Python, label=tlog_python]
def tlog(file = "/var/www/datalog/default.csv"):
	"""salva temperatura e Unix Time em .csv """
	tsample = 0.2202 #amostra a cada ~1 segundo
	buff_temp = tread()#guarda o último valor lido
	exist = os.path.isfile(file)
	with open(file, 'a', 1) as log:
		if exist is False:#se vai criar o arquivo agora
			log.write("temperatura,data\n")
		while True: #loop infinito
			temp_celsius = tread()
			epoch = time.time()#lê a data/hora do sistema
			if temp_celsius >= 0:#evita leitura errada
				log.write("%f,%f\n" % (temp_celsius, epoch))
				tlog_instant(temp_celsius, epoch)
				time.sleep(tsample)#espera n segundos
				print "registrando temperatura!",temp_celsius
\end{lstlisting}

\lstset{language=Python}
\begin{lstlisting}[frame=single, basicstyle=\linespread{0.85}\ttfamily, caption=Script para gravação das leituras de temperatura em Python, label=tlog_log]
import temp
temp.tlog()
# para executar no terminal, basta executar:
# sudo python log.py
\end{lstlisting}

\subsection{Gráfico de temperatura}
\label{python_graph}

Com o script que gera um registro da temperatura medida pelo sensor DS18B20 em função do tempo, o próximo passo é a análise dos dados coletados, sendo uma das ferramentas de análise a plotagem de um gráfico. Para fazê-lo em Python, foi decido usar as bibliotecas \textit{Matplotlib} e \textit{NumPy}, integrantes do ecossistema \textit{SciPy}.

\textit{Matplotlib} é uma biblioteca desenvolvida especificamente para a plotagem 2D de figuras estáticas em scripts Python, no Python shell (similar ao ambiente interpretador de \textit{softwares} proprietários como MATLAB e Mathematica), em aplicações de servidores e \textit{toolkits} com GUI \cite{matplotlib}. Para instalar esta biblioteca, bastou executar o comando descrito na caixa de código-fonte \ref{install_matplotlib}.

\lstset{language=bash}
\begin{lstlisting}[frame=single, basicstyle=\linespread{0.85}\ttfamily, caption=Instalação da biblioteca Matplotlib, label=install_matplotlib]
sudo apt-get install python-matplotlib
\end{lstlisting}

\textit{NumPy} é um pacote em Python que fornece suporte a arranjos e matrizes multidimensionais, além de diversas funções matemáticas de suporte a estes formatos de dados. É amplamente empregado nas áreas de computação científica, engenharia e matemática \cite{numpy}. Este pacote é parte integrante do ecossistema \textit{SciPy}, cuja instalação é apresentada na caixa de código-fonte \ref{install_scipy}.

\lstset{language=bash}
\begin{lstlisting}[frame=single, basicstyle=\linespread{0.85}\ttfamily, caption=Instalação do ecossistema SciPy, label=install_scipy]
sudo apt-get install python-scipy
\end{lstlisting}

\subsubsection{Desenvolvimento do gráfico}

Com todas as ferramentas necessárias instaladas, pôde ser iniciado o desenvolvimento do script que gera o gráfico da temperatura em função do tempo. A abordagem inicial foi criar um script que gera um arquivo PDF do gráfico a partir do exemplo encontrado na página \url{http://matplotlib.org/examples/pylab_examples/multipage_pdf.html} , modificando este script para as necessidades do projeto.

Como o desenvolvimento foi realizado sem uma interface gráfica, referida como \textit{backend}, foi preciso explicitar a saída como um renderizador, conforme indicado no código-fonte \ref{import_py}, que documenta a importação das bibliotecas/funções utilizadas no script. Note-se que a mudança da saída ocorreu necessariamente antes da importação da biblioteca \textit{numpy} para que não ocorresse erro.

\lstset{language=Python}
\begin{lstlisting}[frame=single, basicstyle=\linespread{0.85}\ttfamily, caption=Importação das bibliotecas para geração de gráfico em Python, label=import_py]
import time
import matplotlib
matplotlib.use('AGG')#muda a output para um renderer ao inves de backend
import numpy as np
import matplotlib.pyplot as plt
from scipy import interpolate
\end{lstlisting}

Na única função do script, \textit{graph\_gen(file = '/var/www/default.csv', graph = '/var/www/tplot.png')}, foi explicitado que a entrada é um arquivo CSV e a saída um arquivo PNG. Nesta função o arquivo CSV foi lido linha por linha em um \textit{loop}, sendo a primeira linha do arquivo ignorada em função de ela não conter dados, conforme ilustrado na figura \ref{csv_log_example}. Ao longo das iterações deste \textit{loop}, a data/hora do primeiro e último registro de temperatura foram usadas para gerar um título para o gráfico e, a cada iteração os dados são decodificados, o que se resume basicamente a separar o que há antes e depois da vírgula presente na linha lida do arquivo CSV.

Na parte da função referente à plotagem do gráfico, além de configurações triviais como cor de fundo, tamanho de fontes e legendas, dentre outras, é notável o ajuste da escala do tempo, para o qual foi pensado um registro de temperatura contínuo e não somente o registro de uma produção de cerveja: para até duas horas de registro a escala é impressa em minutos; entre duas horas e um dia e meio de registros, em horas; entre um dia e meio e três meses de registros, em dias; e acima disto em meses. Após isto, o gráfico é plotado, salvo no formato PNG com densidade de pontos por polegada de 150dpi, e fechado para liberar a memória do sistema.

O script que chama a função \textit{graph\_gen} está presente no mesmo arquivo em que está a função. Note-se que o gráfico é gerado periodicamente a cada 300 segundos e o tempo necessário para executar tal tarefa é computado e impresso na saída padrão do Python. O arquivo completo que contém a função \textit{graph\_gen} está documentado no código-fonte \ref{python_graph_script} do apêndice \ref{codigos_python}.
