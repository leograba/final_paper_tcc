BBB é uma placa de sistema embarcado desenvolvida para a comunidade de código aberto (\textit{open-source}), iniciantes e quaisquer pessoas interessadas em um sistema equipado com um processador ARM Cortex-A8 32-bits de baixo custo, seja para teste de conceito ou mesmo uso pessoal e profissional, embora o último não seja o mais adequado. Embora o sistema tenha sido desenvolvido com um número reduzido de funcionalidades, de modo a proporcionar uma experiência de uso simples, este SBC não é uma plataforma completa de desenvolvimento nem é voltada para o desenvolvimento de um produto específico, mas sim para a experimentação e aprendizado nas áreas de \textit{software} e \textit{hardware} \cite{bbb_srm}. A figura \ref{bbb} apresenta a placa e seus principais componentes, em conjunto com a tabela \ref{bbb_specs}, onde estão contidas as especificações gerais de hardware e a figura \ref{bbb-bdg}, na qual está contido um diagrama de blocos do sistema, de alto nível de abstração. O diagrama esquemático do sistema pode ser obtido no Anexo \ref{Anexo1}.

É imprescindível atentar para o fato de que a BBB possui diversas revisões de \textit{hardware}, sendo que a versão utilizada neste trabalho é a \textbf{revisão C}.

A combinação do processador ARM Cortex-A8 com o projeto de \textit{hardware} da placa possibilita o uso de um sistema operacional embarcado -- geralmente uma distribuição Linux -- que fornece facilidades de programação, a exemplo de uma IDE acessada pelo navegador da internet chamada Cloud9 em combinação com uma biblioteca de acesso ao hardware em \textit{server-side} Javascript (Node.js), possibilitando a prototipagem rápida de soluções embarcadas de produtos voltados ao mundo real. À medida que o desenvolvedor do sistema se torna mais experiente, é possível desenvolver soluções mais complicadas em diversas linguagens de programação, utilizando-se para isto do sistema operacional Linux embarcado na placa. \cite{bbb_nannan}. Além disso, projetos como o do carro de controle remoto via web, desenvolvido por \cite{bbb_nannan} com o intuito de confirmar as capacidades deste SBC e seu potencial uso no ensino de sistemas embarcados, reforçam a escolha da BBB como plataforma para este projeto. É importante notar que alguns dos pontos fortes deste SBC, ou computador de placa única, estão implícitos em sua classificação: por ser um computador, ele apresenta os benefícios de uma plataforma que suporta um universo de múltiplas aplicações --- embora restrito pelo reduzido poder de processamento se comparado a um computador tradicional --- e, no caso da escolha do Linux como sistema operacional, traz os benefícios de um \textit{kernel} amplamente estável. 

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.55]{./Resources/bbb-components.jpg}
	\captionsetup{justification=centering}
	\caption[BeagleBone Black e principais componentes]{BeagleBone Black e principais componentes. \\Fonte: COLEY (2014)
	}
	\label{bbb}
\end{figure}

\begin{itemize}
	\item \textbf{Sitara AM3358BZCZ100} - SoC (\textit{system on chip})
	\item \textbf{Micron 512MB DDR3L ou Kingston 512MB DDR3} - memória RAM
	\item \textbf{TPS65217C PMIC} - controlador de alimentação dos diferentes componentes do sistema
	\item \textbf{SMSC Ethernet PHY} - interface física à rede Ethernet
	\item \textbf{Micron eMMC} - memória não volátil MMC de 4GB
	\item \textbf{HDMI Framer} - controlador para uso com display HDMI ou DVI-D
\end{itemize}

\begin{center}
	\begin{table}[H]
		\captionsetup{justification=centering}
		\caption[Especificações Gerais da BeagleBone Black]{Especificações Gerais da BeagleBone Black. \\Fonte: adaptado de COLEY(2014)}
		\label{bbb_specs}
		\begin{tabular}{ | M{3cm} | M{12cm} |}
			\hline
			& \multicolumn{1}{|c|}{\textbf{Especificação}} \\ \hline
			Processador & Sitara AM3358BZCZ100, 1GHz, 2000 MIPS\\ \hline
			Motor Gráfico & SGX530 3D, 20M polígonos/s \\ \hline
			Memória SDRAM & 512MB DDR3L 800MHz \\ \hline
			Memória Flash & 4GB, 8bit eMMC \\ \hline
			CI Gerenciador de Alimentação & TPS65217C + regulador adicional (linear) \\ \hline
			Suporte a \textit{debug} & Interface serial, Conector CTI JTAG opcional de 20 pinos \\ \hline
			Fonte de Alimentação & mini USB, conector DC ou 5VDC na barra de pinos\\ \hline
			PCB & 8,64cm x 5,33cm (3,4" x 2,1") - 6 \textit{layers}\\ \hline
			Leds Indicadores & 1 para alimentação; 2 para Ethernet; 4 acessíveis ao usuário \\ \hline
			USB 2.0 \textit{Client} & Acesso à USB0 via miniUSB \\ \hline
			USB 2.0 \textit{Host} & Acesso à USB1, soquete tipo A, 500mA LS/FS/HS \\ \hline
			Serial & Acesso à UART0 via \textit{header} de 6 pinos, TTL 3.3V \\ \hline
			Ethernet & 10/100 RJ45 \\ \hline
			SD/MMC & Conector microSD, 3,3V \\ \hline
			Chaves & Botões push de reset, boot e alimentação \\ \hline
			Saída de vídeo & 16b HDMI, 1280x1024 (MAX), 1024x768, 1280x720, 1440x900, 1920x1080@24Hz \\ \hline
			Audio & Via interface HDMI, estéreo \\ \hline
			Conectores de expansão & Alimentação 5V, 3,3V e VDD\_ADC(1,8V) \newline 3,3V para todos os sinais de E/S \newline McASP0, SPI, I2C, até 69 pinos de GPIO, LCD, GPMC, MMC1, MMC2, 7 entradas para conversor A/D (1,8V MAX), 4 \textit{timers}, 4 UART, CAN, PWM via \textit{hardware}, interrupção XDMA\\ \hline
			Peso & 39,68g (1,4oz) \\ \hline
			Consumo@5VDC & Ocioso - 280mA \newline Carregando página web - 430mA \newline \*O consumo varia conforme o desempenho \\
			\hline
		\end{tabular}
	\end{table}
\end{center}

Cada pino de GPIO digital da BBB possui até 7 modos diferentes de operação, que são configurados utilizando uma ferramenta do Linux chamada \textit{Device Tree}. A figura \ref{bbb_pins_def} apresenta a configuração padrão dos pinos, ou seja, quando é usada a distribuição Debian do Linux, pré-compilada e que é fornecida com a placa. Com relação aos pinos de GPIO, é importante notar que sua lógica opera com níveis de tensão de 0V e 3,3V para os níveis baixo e alto, respectivamente e portanto aplicar uma tensão negativa ou superior a 3,3V pode danificar permanentemente a placa \cite{lumme}.

\newpage

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.80]{./Resources/bbb-blockDG.jpg}
	\captionsetup{justification=centering}
	\caption[Diagrama de blocos de alto nível da BeagleBone Black]{Diagrama de blocos de alto nível da BeagleBone Black. \\Fonte: COLEY (2014)
	}
	\label{bbb-bdg}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.80]{./Resources/bbb-pins-def.jpg}
	\captionsetup{justification=centering}
	\caption[Configuração padrão dos pinos da BeagleBone Black]{Configuração padrão dos pinos da BeagleBone Black. \\Fonte: Site oficial da Fundação BeagleBoard.org\protect\footnotemark
	}
	\label{bbb_pins_def}
\end{figure}

\footnotetext{Disponível em \url{http://beagleboard.org/Support/bone101}}

\subsection{\textit{Programmable Real-time Unit -- PRU-ICSS}}

A PRU-ICSS -- \textit{Programmable Real-Time Unit Subsystem and Industrial Communications Subsystem} (Unidade Programável de Tempo-Real e Subsistema de Comunicação Industrial, em tradução livre) é um subsistema do processador AM3358 que equipa a BBB, fabricado pela \textit{Texas Instruments}, embora não possua suporte oficial da mesma \cite{bbb_srm}. Em uma fase inicial de desenvolvimento do projeto, foi vislumbrado o uso desta unidade para implementação de um controlador de temperatura e, embora o desenvolvimento deste tenha sido interrompido, foi realizada uma revisão teórica da PRU, exposta no apêndice \ref{apendice_pru}.

\subsection{\textit{Device Tree}}
\label{dt_section}

A \textit{Device Tree} ou DT é basicamente uma estrutura de dados utilizada para descrever \textit{hardware}, cujo objetivo é possibilitar que as características de \textit{hardware} de um sistema específico sejam passadas para o SO durante o \textit{boot}, ao invés de estas informações ficarem gravadas no SO \cite{devicetree}, o que possibilita que um \textit{driver} do Kernel seja usado em configurações diferentes de \textit{hardware} sem a necessidade de modificações em seu código-fonte. Com relação aos sistemas equipados com processadores ARM, a necessidade de uso da DT surgiu devido ao grande número de novas placas, que tornou muito difícil manter uma versão do Kernel para cada sistema. Seu objetivo não é modificar o sistema em tempo de execução, porém no caso da BBB, foi criada uma solução chamada \textit{Device Tree Overlay} (ou sobreposição) para executar esta função, facilitando a configuração de GPIO, dentre outras funções, e uso da DT pelo usuário final \cite{bbb_devicetree}, fatores que são do interesse de aprendizes da área.

Uma DT é uma estrutura em árvore, composta de nós e propriedades. Uma abordagem para entender o seu funcionamento é por meio de um exemplo de sobreposição específico para a BBB. Na caixa de código-fonte \ref{dt_example} é apresentado um exemplo de sobreposição de DT específico da BBB que apresenta os principais conceitos para o uso desta ferramenta.

Neste código, na linha 14 é definida a plataforma à qual esta DT se refere. Com isso, ficam declaradas as funcionalidades de \textit{hardware} do sistema. Na sequência, a identificação mostra quais sobreposições de DT estão carregadas e o nome do arquivo compilado deve ser igual ao nome nela atribuído; a versão deve ser 00A0 para a BBB. Entre as linhas 20 e 26 são listados os recursos de \textit{hardware} utilizados por esta sobreposição, que impedem que outras sobreposições que usem os mesmos recursos sejam carregadas; no caso deste exemplo, os pinos referentes à UART1, assim como o próprio dispositivo UART1 são utilizados. A seguir, os fragmentos descrevem qual dispositivo terá suas configurações sobrepostas. No fragmento 0, é o multiplexador dos pinos da BBB, compatível com o \textit{driver} \textit{pinctrl-single} - os dois valores hexadecimais utilizados para cada pino são o \textit{offset} do pino com relação ao seu registrador e a configuração do pino. Já no fragmento 1 é configurada a interface UART1. Por enquanto, serão introduzidas somente as questões referentes à configuração do multiplexador, uma vez que seu conhecimento foi necessário para o uso dos pinos no modo GPIO.

Para determinar o valor hexadecimal de \textit{offset} do pino ao qual se deseja aplicar uma configuração, primeiro é preciso obter seu nome a partir do seu número na barra de pinos, conforme ilustrado na figura \ref{bbb_pins_def}, consultando as tabelas \ref{p8-header} e \ref{p9-header}, nas quais o nome do pino é referente ao \textbf{modo 0}, que também é o nome do pino no manual do SoC \cite{bbb_srm, soc_manual}. A seguir, obtém-se o valor hexadecimal do registrador referente ao pino, na tabela \ref{dt_offset} presente no anexo \ref{Anexo2}, adaptada do manual do SoC, e subtrai-se 0x800 de seu valor original.

\newpage

\lstset{language=dtc}
\begin{lstlisting}[frame=single, basicstyle=\linespread{0.85}\ttfamily, caption=Sobreposição de \textit{device tree}, label=dt_example]
/* Copyright (C) 2013 CircuitCo */
/dts-v1/;
/plugin/;

/ {
	compatible = "ti,beaglebone", "ti,beaglebone-black";

	/* identification */
	part-number = "BB-UART1";
	version = "00A0";
	
	/* state the resources this cape uses */
	exclusive-use =
		/* the pin header uses */
		"P9.24",        /* uart1_txd */
		"P9.26",        /* uart1_rxd */
		/* the hardware ip uses */
		"uart1";
	
	fragment@0 {
		target = <&am33xx_pinmux>;
		__overlay__ {
			bb_uart1_pins: pinmux_bb_uart1_pins {
				pinctrl-single,pins = <
		/* P9.24 uart1_txd.uart1_txd MODE0 OUTPUT (TX) */
					0x184 0x20
		/* P9.26 uart1_rxd.uart1_rxd MODE0 INPUT (RX) */ 
					0x180 0x20
				>;
			};
		};
	};
	
	fragment@1 {
		target = <&uart2>;	/* really uart1 */
		__overlay__ {
			status = "okay";
			pinctrl-names = "default";
			pinctrl-0 = <&bb_uart1_pins>;
		};
	};
};
\end{lstlisting}

%\newpage

Com relação à configuração do pino, este aceita os parâmetros de ajuste de \textit{slew-rate}, ativação do \textit{buffer} de entrada, ajuste e ativação do \textit{pull-up/pull-down} interno e seleção do modo de operação do pino. Note-se que, com relação ao buffer de entrada, ao menos um blog da internet refere-se a este bit como sendo um bit de seleção para entrada \textbf{ou} saída \cite{derek_devtree}, porém o manual indica que quando o bit está setado, o pino pode ser usado tanto como entrada quanto saída \cite{soc_manual}. A tabela \ref{pad_cfg} apresenta os campos do registrador de controle de E/S, assim como a descrição de cada campo e os valores aceitos.

\begin{center}
	\begin{table}[H]
		\captionsetup{justification=centering}
		\caption[Descrição dos campos do registrador de controle de \textit{pads}]{Descrição dos campos do registrador de controle de \textit{pads}. \\Fonte: adaptado de TEXAS INSTRUMENTS(2014)}
		\label{pad_cfg}
		\begin{tabular}{ | M{1cm} | M{3cm} | M{1cm} | M{10cm} |}
			\hline
			\textbf{Bit} & \textbf{Campo} & \textbf{Valor} & \textbf{Descrição} \\ \hline
			31-7 & Reservado &  & Reservado. Leitura retorna 0 \\ \hline
			6 & SLEWCTRL & \shortstack{ \quad \\ 0 \\ 1} & \shortstack{Seleciona entre \textit{slew-rate} rápido ou lento \\ 0 - rápido \\ 1 - lento} \\ \hline
			5 & RXACTIVE & \shortstack{ \quad \\ 0 \\ 1} & \shortstack{Ativa modo de entrada para o pino \\ 0 - somente saída \\ 1 - Receptor ativado. Entrada ou saída}. \\ \hline
			4 & PULLTYPESEL & \shortstack{ \quad \\ 0 \\ 1} & \shortstack{Seleção de pull-up/pull-down \\ 0 - pull-down \\ 1 - pull-up} \\ \hline
			3 & PULLUDEN & \shortstack{ \quad \\ 0 \\ 1} & \shortstack{Habilita pull-up/pull-down \\ 0 - habilitado \\ 1 - desabilitado} \\ \hline
			2-0 & MUXMODE & 0-7 & Seleção de funcionalidade do pino multiplexado \\ \hline
		\end{tabular}
	\end{table}
\end{center}

%\newpage

%tabela do header 8
\begin{minipage}[t][.49\textheight]{1\textwidth}
	\begin{center}
		\begin{table}[H]
			\captionsetup{justification=centering}
			\caption[Lista de pinos do \textit{header} P8 e seus respectivos modos de funcionamento]{Lista de pinos do \textit{header} P8 e seus respectivos modos de funcionamento \\ Fonte: COLEY (2014)}
			\label{p8-header}
			\begin{center}
				\includegraphics[page=1, height=0.5\textheight]{./Resources/tabela_pinos_SRM.pdf}
			\end{center}
		\end{table}
		%\includegraphics[page=3, scale=0.5]{./Resources/BBB_SCH.pdf}
	\end{center}
\end{minipage}

\newpage

%tabela do header 9
\begin{minipage}[b][.49\textheight]{1\textwidth}
	\begin{center}
		\begin{table}[H]
			\captionsetup{justification=centering}
			\caption[Lista de pinos do \textit{header} P9 e seus respectivos modos de funcionamento]{Lista de pinos do \textit{header} P9 e seus respectivos modos de funcionamento \\ Fonte: COLEY (2014)}
			\label{p9-header}
			\begin{center}
				\includegraphics[page=2, height=0.5\textheight]{./Resources/tabela_pinos_SRM.pdf}
			\end{center}
		\end{table}
		%\includegraphics[page=3, scale=0.5]{./Resources/BBB_SCH.pdf}
	\end{center}
\end{minipage}

%Páginas relevantes do manual do SoC
%1356 - pullup, RXactive, etc e 1365 - registers offset, 1422 - registrador
